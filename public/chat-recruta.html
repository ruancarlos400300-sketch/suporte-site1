<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orbitron | Atendimento</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="/firebase-config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #111214;
            --bg-chat: #1e1f22;
            --eb-ouro: #d4af37;
            --text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }

        body {
            background-color: var(--bg-body);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        header {
            padding: 15px 20px;
            background: var(--bg-chat);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #333;
        }

        .status-dot { width: 10px; height: 10px; background: #23a559; border-radius: 50%; margin-right: 10px; }

        /* ÁREA DE MENSAGENS */
        #chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .msg {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
        }

        .msg.recruta { align-self: flex-end; background: var(--eb-ouro); color: #000; border-bottom-right-radius: 2px; }
        .msg.staff { align-self: flex-start; background: #2b2d31; color: #fff; border-bottom-left-radius: 2px; }

        /* INPUT FIXO NO RODAPÉ */
        .footer {
            padding: 15px;
            background: var(--bg-chat);
            display: flex;
            gap: 10px;
            border-top: 1px solid #333;
        }

        input {
            flex: 1;
            background: #000;
            border: 1px solid #444;
            padding: 12px 15px;
            border-radius: 25px;
            color: #fff;
            outline: none;
        }

        .btn-send {
            background: var(--eb-ouro);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            color: #000;
        }
    </style>
</head>
<body>

    <header>
        <div style="display: flex; align-items: center;">
            <div class="status-dot"></div>
            <div>
                <h4 id="display-nick">Carregando...</h4>
                <p id="display-id" style="font-size: 10px; color: var(--eb-ouro);"></p>
            </div>
        </div>
        <img src="https://i.imgur.com/8Y6E7Gv.png" style="width: 35px;">
    </header>

    <div id="chat-box">
        </div>

    <div class="footer">
        <input type="text" id="msg-input" placeholder="Digite sua mensagem...">
        <button class="btn-send" onclick="ChatEngine.enviar()">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>

    <script>
        const ChatEngine = {
            ticketID: new URLSearchParams(window.location.search).get('id') || localStorage.getItem('meu_ticket'),
            meuNome: localStorage.getItem('meu_nome') || "Recruta",

            init: () => {
                if (!ChatEngine.ticketID) {
                    alert("Ticket não encontrado. Voltando ao início.");
                    window.location.href = "/";
                    return;
                }

                document.getElementById('display-nick').innerText = ChatEngine.meuNome;
                document.getElementById('display-id').innerText = "PROTOCOLO: #" + ChatEngine.ticketID.slice(-6).toUpperCase();

                ChatEngine.ouvirMensagens();
            },

            ouvirMensagens: () => {
                db.ref(`mensagens/${ChatEngine.ticketID}`).on('value', snap => {
                    const box = document.getElementById('chat-box');
                    box.innerHTML = "";
                    
                    snap.forEach(child => {
                        const m = child.val();
                        const isEu = m.tipo === 'recruta';
                        
                        const div = document.createElement('div');
                        div.className = `msg ${isEu ? 'recruta' : 'staff'}`;
                        div.innerText = m.texto;
                        box.appendChild(div);
                    });
                    box.scrollTop = box.scrollHeight;
                });
            },

            enviar: () => {
                const input = document.getElementById('msg-input');
                const texto = input.value.trim();
                
                if (!texto) return;

                db.ref(`mensagens/${ChatEngine.ticketID}`).push({
                    autor: ChatEngine.meuNome,
                    texto: texto,
                    tipo: 'recruta',
                    timestamp: Date.now()
                });

                input.value = "";
            }
        };

        window.onload = ChatEngine.init;
        document.getElementById('msg-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') ChatEngine.enviar();
        });
    </script>
</body>
</html>
