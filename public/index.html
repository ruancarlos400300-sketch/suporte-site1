<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>CENTRAL ORBITRON</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="/firebase-config.js"></script>
    <style>
        :root { --bg: #313338; --card: #2b2d31; --blue: #5865F2; --green: #23a559; --text: #dbdee1; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'gg sans', sans-serif; }
        body { background: var(--bg); color: white; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        .container { background: var(--card); padding: 40px; border-radius: 16px; width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; transition: 0.3s; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        input { width: 100%; padding: 14px; background: #1e1f22; border: none; border-radius: 8px; color: white; margin-bottom: 20px; outline: none; }
        .btn { width: 100%; padding: 14px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-blue { background: var(--blue); color: white; margin-bottom: 15px; }
        .btn-blue:hover { background: #4752c4; transform: scale(1.02); }

        /* Chat e Estrelas */
        #chat-area { display: none; text-align: left; }
        .msgs { height: 250px; overflow-y: auto; background: #1e1f22; border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        .stars { font-size: 35px; color: #4e5058; margin: 20px 0; }
        .stars span { cursor: pointer; transition: 0.2s; }
        .stars span.active { color: #faa61a; text-shadow: 0 0 10px rgba(250, 166, 26, 0.5); }
    </style>
</head>
<body>

    <div class="container" id="box">
        <div id="setup-area">
            <h1 style="margin-bottom: 10px;">Suporte Orbitron</h1>
            <p style="color: #b5bac1; margin-bottom: 30px;">Inicie seu atendimento militar abaixo.</p>
            <input type="text" id="player-nick" placeholder="Seu Nick no Discord">
            <button class="btn btn-blue" onclick="abrirTicket()">PRECISO DE AJUDA</button>
            <p style="font-size: 13px; color: #b5bac1;">Staff? <span style="color: #00a8fc; cursor: pointer;" onclick="window.location.href='/login'">ENTRAR COMO CAC</span></p>
        </div>

        <div id="chat-area">
            <h3 id="atend-nome" style="margin-bottom: 15px;">Aguardando...</h3>
            <div class="msgs" id="msg-box"></div>
            <input type="text" id="player-input" placeholder="Diga algo..." onkeypress="if(event.key==='Enter') enviarMsg()">
        </div>

        <div id="eval-area" style="display:none;">
            <h2>Avalie o Atendimento</h2>
            <div class="stars" id="star-list">
                <span onclick="setStar(1)">★</span><span onclick="setStar(2)">★</span><span onclick="setStar(3)">★</span><span onclick="setStar(4)">★</span><span onclick="setStar(5)">★</span>
            </div>
            <button class="btn btn-blue" style="background: var(--green);" onclick="confirmarAvaliacao()">ENVIAR AVALIAÇÃO</button>
        </div>
    </div>

    <script>
        let ticketId = null;
        let rating = 0;

        function abrirTicket() {
            const nick = document.getElementById('player-nick').value;
            if(!nick) return;
            const ref = db.ref('tickets').push();
            ticketId = ref.key;
            
            // Mensagem Automática Inicial
            ref.set({ nick: nick, status: 'aberto', criadoEm: Date.now() });
            ref.child('mensagens').push({ autor: 'SISTEMA', texto: `Olá ${nick}, a Staff Orbitron foi notificada. Aguarde um instante.` });

            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('chat-area').style.display = 'block';
            escutar();
        }

        function escutar() {
            db.ref('tickets/' + ticketId).on('value', snap => {
                const t = snap.val();
                if(t && t.status === 'avaliando') {
                    document.getElementById('chat-area').style.display = 'none';
                    document.getElementById('eval-area').style.display = 'block';
                }
            });
            db.ref('tickets/' + ticketId + '/mensagens').on('child_added', snap => {
                const m = snap.val();
                const p = document.createElement('div');
                p.style.marginBottom = "8px";
                p.innerHTML = `<b style="color:${m.autor==='SISTEMA'?'#faa61a':m.autor==='staff'?'#5865f2':'#23a559'}">${m.autor}:</b> ${m.texto}`;
                document.getElementById('msg-box').appendChild(p);
                document.getElementById('msg-box').scrollTop = document.getElementById('msg-box').scrollHeight;
            });
        }

        function setStar(n) {
            rating = n;
            document.querySelectorAll('.stars span').forEach((s, i) => s.classList.toggle('active', i < n));
        }

        function confirmarAvaliacao() {
            if(rating === 0) return alert("Selecione as estrelas!");
            db.ref('tickets/' + ticketId).once('value', snap => {
                const t = snap.val();
                const bonus = 1 + (rating * 0.3);
                db.ref('usuarios/' + t.atendidoPor + '/pontos').transaction(p => (p || 0) + bonus);
                db.ref('tickets/' + ticketId).remove().then(() => {
                    alert("Obrigado! Pontuação atribuída ao militar.");
                    window.location.reload();
                });
            });
        }

        function enviarMsg() {
            const i = document.getElementById('player-input');
            if(i.value) db.ref('tickets/' + ticketId + '/mensagens').push({ autor: 'player', texto: i.value });
            i.value = "";
        }
    </script>
</body>
</html>
