<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CENTRAL DE TICKETS | EB ORBITRON</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="/firebase-config.js"></script>
    <script src="/logs.js"></script>
    <style>
        /* Ajustes específicos para o layout de Chat Estilo Discord */
        body { align-items: stretch; overflow: hidden; height: 100vh; }
        
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
            background: var(--bg-discord);
        }

        /* Barra Lateral de Canais (Tickets) */
        .sidebar-tickets {
            width: 260px;
            background: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(0,0,0,0.2);
        }

        .sidebar-header {
            padding: 15px;
            font-weight: bold;
            font-size: 14px;
            border-bottom: 1px solid rgba(0,0,0,0.2);
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ticket-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .ticket-item {
            padding: 8px 12px;
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }

        .ticket-item:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .ticket-item.active { background: rgba(255,255,255,0.1); color: white; }
        .ticket-item::before { content: "#"; color: var(--text-muted); font-size: 18px; }

        /* Área do Chat */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-discord);
        }

        .chat-header {
            height: 48px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.2);
            font-weight: bold;
            gap: 10px;
        }

        #messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message-block {
            display: flex;
            gap: 15px;
        }

        .avatar-eb {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--eb-verde);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .msg-content { flex: 1; }
        .msg-author { font-weight: bold; color: white; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .msg-text { color: var(--text-primary); font-size: 15px; margin-top: 4px; line-height: 1.4; }

        .chat-input-wrapper {
            padding: 0 20px 24px 20px;
        }

        .input-box {
            background: #383a40;
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
        }

        .input-box input {
            background: transparent;
            border: none;
            padding: 5px;
            color: white;
            flex: 1;
        }

        /* Recorte Mobile */
        @media (max-width: 768px) {
            .sidebar-tickets { width: 80px; }
            .sidebar-header span, .ticket-item span { display: none; }
            .sidebar-header { justify-content: center; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="sidebar-tickets">
            <div class="sidebar-header">
                <img src="https://i.imgur.com/8Y6E7Gv.png" width="24">
                <span>COMANDO EB</span>
            </div>
            <div class="ticket-list" id="ticket-list">
                </div>
            <div style="padding: 10px; background: rgba(0,0,0,0.1);">
                <div id="militar-nome" style="font-size: 12px; font-weight: bold;">Carregando...</div>
                <div id="militar-cargo" class="badge" style="margin-top:5px;">OFFLINE</div>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <span style="color: var(--text-muted); font-size: 20px;">#</span>
                <span id="current-ticket-name">Selecione um ticket</span>
                <button onclick="finalizarTicket()" class="btn-eb" style="width: auto; padding: 5px 15px; margin-left: auto; background: var(--danger); font-size: 12px;">Finalizar</button>
            </div>

            <div id="messages-container">
                <div style="text-align: center; color: var(--text-muted); margin-top: 100px;">
                    <img src="https://i.imgur.com/8Y6E7Gv.png" width="80" style="opacity: 0.2;">
                    <p style="margin-top: 10px;">Aguardando seleção de canal tático...</p>
                </div>
            </div>

            <div class="chat-input-wrapper">
                <div class="input-box">
                    <input type="text" id="msg-input" placeholder="Enviar mensagem para o recruta..." onkeypress="if(event.key === 'Enter') enviarMsg()">
                    <button onclick="enviarMsg()" style="background: transparent; border: none; color: var(--eb-ouro); cursor: pointer; font-weight: bold;">ENVIAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const minhaChave = localStorage.getItem('militar_chave');
        let ticketAtivo = null;
        let dadosMilitar = null;

        if(!minhaChave) window.location.href = '/login';

        // Carregar Perfil
        db.ref('logins_gerados/' + minhaChave).once('value', s => {
            dadosMilitar = s.val();
            if(!dadosMilitar) window.location.href = '/login';
            document.getElementById('militar-nome').innerText = dadosMilitar.responsavel.toUpperCase();
            document.getElementById('militar-cargo').innerText = dadosMilitar.cargo.toUpperCase();
        });

        // Monitorar Tickets
        db.ref('tickets').on('value', snap => {
            const list = document.getElementById('ticket-list');
            list.innerHTML = "";
            snap.forEach(t => {
                const data = t.val();
                if(data.status === 'aberto') {
                    const item = document.createElement('div');
                    item.className = `ticket-item ${ticketAtivo === t.key ? 'active' : ''}`;
                    item.innerHTML = `<span>${data.nome_usuario}</span>`;
                    item.onclick = () => carregarTicket(t.key, data.nome_usuario);
                    list.appendChild(item);
                }
            });
        });

        function carregarTicket(id, nome) {
            ticketAtivo = id;
            document.getElementById('current-ticket-name').innerText = nome;
            
            db.ref('mensagens/' + id).on('value', snap => {
                const container = document.getElementById('messages-container');
                container.innerHTML = "";
                snap.forEach(m => {
                    const msg = m.val();
                    const isMilitar = msg.tipo === 'staff';
                    container.innerHTML += `
                        <div class="message-block">
                            <div class="avatar-eb" style="${isMilitar ? 'background:var(--eb-ouro); color:black;' : ''}">
                                ${msg.autor[0].toUpperCase()}
                            </div>
                            <div class="msg-content">
                                <div class="msg-author">
                                    ${msg.autor} 
                                    ${isMilitar ? `<span class="badge" style="font-size:8px;">STAFF</span>` : ''}
                                </div>
                                <div class="msg-text">${msg.texto}</div>
                            </div>
                        </div>
                    `;
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        function enviarMsg() {
            const txt = document.getElementById('msg-input').value.trim();
            if(!txt || !ticketAtivo) return;

            db.ref('mensagens/' + ticketAtivo).push({
                autor: dadosMilitar.responsavel,
                texto: txt,
                tipo: 'staff',
                timestamp: Date.now()
            });

            document.getElementById('msg-input').value = "";
        }

        function finalizarTicket() {
            if(!ticketAtivo) return;
            if(confirm("Deseja encerrar este atendimento militar?")) {
                db.ref('tickets/' + ticketAtivo).update({ status: 'fechado' });
                enviarLog("✅ ATENDIMENTO FINALIZADO", [
                    { name: "Militar", value: dadosMilitar.responsavel, inline: true },
                    { name: "Ticket", value: document.getElementById('current-ticket-name').innerText, inline: true }
                ], 2335833);
                ticketAtivo = null;
                location.reload();
            }
        }
    </script>
</body>
</html>
