<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Staff | EB</title>
    <link rel="stylesheet" href="/style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar" id="side">
            <div style="padding:1.5rem; border-bottom:1px solid rgba(255,255,255,0.05);">
                <h1 style="font-size:12px; font-weight:900; color:#6366f1;">ORBITRON CAC</h1>
            </div>
            <div id="lista-canais" style="padding:1rem; flex:1; overflow-y:auto;">
                <p style="font-size:10px; color:#475569;">AGUARDANDO CHAMADOS...</p>
            </div>
        </aside>

        <main style="flex:1; display:flex; flex-direction:column;">
            <header style="padding:1.5rem; background:#0f172a; border-bottom:1px solid rgba(255,255,255,0.05);">
                <span id="atendimento-nome" style="font-weight:800; font-size:14px;">SELECIONE UM PLAYER</span>
            </header>
            <div id="chat-msgs" class="chat-messages" style="background:rgba(0,0,0,0.1);"></div>
            <footer style="padding:1.5rem; background:#0f172a;">
                <input type="text" id="staff-input" placeholder="Comandos: /concluir ou /off">
            </footer>
        </main>
    </div>

    <script>
        const socket = io();
        let trava = false;
        let tAtivo = null;
        let meuEmail = localStorage.getItem('user_email');

        socket.on('novo_ticket_painel', (t) => {
            const l = document.getElementById('lista-canais');
            if(l.innerText.includes("AGUARDANDO")) l.innerHTML = "";
            if(!document.getElementById(t.id)) {
                const div = document.createElement('div');
                div.id = t.id;
                div.style = "padding:1rem; background:rgba(255,255,255,0.03); border-radius:10px; margin-bottom:0.5rem; cursor:pointer;";
                div.onclick = () => {
                    if(trava) return alert("Finalize o atendimento atual!");
                    trava = true; tAtivo = t.id;
                    document.getElementById('side').classList.add('locked');
                    document.getElementById('atendimento-nome').innerText = t.nick;
                    socket.emit('atender_player', { ticketId: t.id, staffEmail: meuEmail });
                };
                div.innerHTML = `<span style="font-size:12px; font-weight:700;"># ${t.nick}</span>`;
                l.appendChild(div);
            }
        });

        document.getElementById('staff-input').onkeypress = (e) => {
            if(e.key === 'Enter' && tAtivo) {
                socket.emit('enviar_mensagem', { ticketId: tAtivo, texto: e.target.value, remetente: 'STAFF' });
                e.target.value = '';
            }
        };

        socket.on('receber_mensagem', (d) => {
            const b = document.getElementById('chat-msgs');
            const cl = d.remetente === 'STAFF' ? 'message-player' : 'message-staff';
            b.innerHTML += `<div class="message ${cl}"><b>${d.remetente}:</b><br>${d.texto}</div>`;
            b.scrollTop = b.scrollHeight;
        });

        socket.on('atendimento_encerrado', () => {
            trava = false; tAtivo = null;
            document.getElementById('side').classList.remove('locked');
            document.getElementById('chat-msgs').innerHTML = "";
            document.getElementById('atendimento-nome').innerText = "SELECIONE UM PLAYER";
            alert("Sess√£o finalizada com sucesso.");
        });
    </script>
</body>
</html>
