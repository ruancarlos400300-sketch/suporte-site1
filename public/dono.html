<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ESTADO-MAIOR | ORBITRON</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="/firebase-config.js"></script>
    <script src="/logs.js"></script>
</head>
<body style="align-items: flex-start; padding-top: 50px;">

    <div class="card-militar" style="max-width: 900px;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 30px;">
            <img src="https://i.imgur.com/8Y6E7Gv.png" width="50"> <h2>Painel de Comando Superior</h2>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            
            <div style="background: var(--bg-input); padding: 20px; border-radius: 8px; text-align: left; border-left: 4px solid var(--eb-ouro);">
                <label>Emitir Ordem de Acesso</label>
                <input type="text" id="staff-nick" placeholder="Nick do Militar (Roblox)">
                <label style="margin-top: 15px;">Patente de Sistema</label>
                <select id="staff-cargo">
                    <option value="atendente">SOLDADO (ATENDENTE)</option>
                    <option value="superior">OFICIAL (SUPERIOR)</option>
                    <option value="dono">GENERAL (DONO)</option>
                </select>
                <button class="btn-eb" style="margin-top: 20px;" onclick="gerarChave()">GERAR CREDENCIAL</button>
                <div id="result-key" style="margin-top: 15px; background: #000; padding: 10px; border-radius: 4px; color: var(--eb-ouro); font-family: monospace; display: none; text-align: center;"></div>
            </div>

            <div style="background: var(--bg-input); padding: 20px; border-radius: 8px; text-align: left; border-left: 4px solid var(--text-muted);">
                <label>Rastreamento de Identidade</label>
                <input type="text" id="search-key" placeholder="Cole a chave ORB aqui">
                <button class="btn-eb" style="background: #4e5058; margin-top: 20px;" onclick="buscar()">PESQUISAR DATABASE</button>
                <div id="result-search" style="margin-top: 15px; font-weight: bold; color: var(--eb-verde-claro);"></div>
            </div>

        </div>

        <h2 style="margin-top: 40px; font-size: 18px; border-bottom: 1px solid var(--bg-input); padding-bottom: 10px;">Efetivo Mobilizado</h2>
        <div id="lista-membros" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px;"></div>
    </div>

    <script>
        function gerarChave() {
            const nick = document.getElementById('staff-nick').value.trim();
            const cargo = document.getElementById('staff-cargo').value;
            if(!nick) return alert("Erro: Identifique o militar.");

            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for(let i=0; i<16; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            const chave = `ORB-${code.match(/.{1,4}/g).join('-')}`;

            db.ref('logins_gerados/' + chave).set({
                responsavel: nick,
                cargo: cargo,
                criadoEm: Date.now()
            }).then(() => {
                const res = document.getElementById('result-key');
                res.innerText = chave;
                res.style.display = 'block';
                enviarLog("ðŸ”‘ NOVA CREDENCIAL GERADA", [
                    { name: "Militar", value: nick, inline: true },
                    { name: "Patente", value: cargo.toUpperCase(), inline: true },
                    { name: "Chave", value: `||${chave}||`, inline: false }
                ], 12951641);
            });
        }

        function buscar() {
            const k = document.getElementById('search-key').value.trim();
            db.ref('logins_gerados/' + k).once('value', s => {
                const d = s.val();
                document.getElementById('result-search').innerText = d ? `IDENTIFICADO: ${d.responsavel} [${d.cargo.toUpperCase()}]` : "âš ï¸ CHAVE NÃƒO ENCONTRADA";
            });
        }

        db.ref('usuarios').on('value', snap => {
            const div = document.getElementById('lista-membros');
            div.innerHTML = "";
            snap.forEach(m => {
                const u = m.val();
                div.innerHTML += `
                <div style="background: var(--bg-input); padding: 15px; border-radius: 8px; border-bottom: 3px solid var(--eb-verde);">
                    <span class="badge">${u.cargo}</span>
                    <div style="margin-top: 8px; font-weight: bold;">${u.nome}</div>
                    <div style="color: var(--eb-verde-claro); font-size: 18px; margin-top: 5px;">${(u.pontos || 0).toFixed(1)} PTS</div>
                </div>`;
            });
        });
    </script>
</body>
</html>
